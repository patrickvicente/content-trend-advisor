version: 2

sources:
  - name: raw_data
    schema: public
    tables:
      - name: raw_content
        loaded_at_field: fetched_at
        description: "Raw API payloads with JSONB under payload"
        columns:
        - name: source
          tests: [not_null]
        - name: external_id
          tests: [not_null]
        - name: payload
          tests: [not_null]


models:
  - name: stg_youtube
    description: "Cleaned YouTube rows from public.raw_content where source = 'youtube'"
    columns:
    - name: video_id
      tests: [unique, not_null]
    - name: published_at
      tests: [not_null]
    - name: view_count
      tests: [not_null]
    - name: engagement_rate
      tests:
        - dbt_utils.accepted_range:
            min_value: 0
    - name: engagement_ratio_raw
      description: "(likes + comments) / views as a raw ratio; can exceed 1.0"
      tests:
        - dbt_utils.accepted_range:
            min_value: 0
    - name: channel_subscriber_count
      description: "Channel subscriber count at ingestion time, if visible"
    - name: yt_trending_seen
      description: "True if video was fetched from YouTube mostPopular during ingestion"